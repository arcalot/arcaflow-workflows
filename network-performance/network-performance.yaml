input:
  root: RootObject
  objects:
    RootObject:
      id: RootObject
      properties:
        global_params:
          required: true
          type:
            items:
              id: GlobalParams
              type_id: ref
            type_id: list
        platform_params:
          required: true
          type:
            items:
              id: PlatformParams
              type_id: ref
            type_id: list
        sut_params:
          required: true
          type:
            items:
              id: SUTParams
              type_id: ref
            type_id: list
        workload_geometry:
          required: true
          type:
            items:
              id: WorkloadGeometry
              type_id: ref
            type_id: list
        uperf_workload:
          required: true
          type:
            items:
              id: UperfWorkload
              type_id: ref
            type_id: list
    GlobalParams:
      properties:
        kubeconfig: 
          #TODO -- Depends on how we implement this
          display:
            description: The complete kubeconfig file as a string
            name: kubeconfig
          type:
            type_id: string
        es_server:
          display:
            description: The URL of the ElasticSearch server for indexing
            name: es_server
          type:
            type_id: string
        uuid: 
          #TODO -- This should be generated by the workflow as a unique identifier
          type:
            type_id: string
        run_id:
          display:
            description: A unique run identifier for tracking groups of workflows triggered by external automation/CI
            name: run_id
          type:
            type_id: string
        cluster_name: 
          #TODO -- This should be captured by the workflow
          type:
            type_id: string
        metadata: #TODO -- This is dependent on how we implement the metadata plugin
          serviceaccount:
            type:
              type_id: string
            default: backpack-view
          targeted:
            type:
              type_id: boolean
            default: false
    PlatformParams:
      #TODO
    SUTParams:
      properties:
        network_policy:
          display:
            description: Whether NetworkPolicy should be enabled
            name: network_policy
          type:
            type_id: boolean
          default: false
        hostnetwork: 
          display:
            description: Whether HostNetwork should be enabled
            name: hostnetwork
          type:
            type_id: boolean
          default: false
        serviceip:
          display:
            description: Whether ServiceIp should be enabled
            name: serviceip
          type:
            type_id: boolean
          default: false
        test_timeout:
          #TODO -- This doesn't seem to be actually used in e2e today. Checking...
          type:
            type_id: integer
          default: 7200
        servicetype: #TODO -- Whatis?
          type:
            type_id: string
    WorkloadGeometry:
      samples:
        #TODO -- Need to think about the loop control for this
        type:
          type_id: integer
        default: 3
      pairs:
        #TODO -- Existing automation only tests with either 1 or 2 pairs; no full-scale tests are done
        type:
          type_id: integer
        default: 2
    UperfWorkload:
      #These parameters map directly to the uperf (client) input schema
      root: Profile
      objects:
        Profile:
          properties:
            groups:
              type:
                items:
                  id: ProfileGroup
                  type_id: ref
                type_id: list
        ProfileGroup:
          properties:
            transactions:
              type:
                items:
                  id: ProfileTransaction
                  type_id: ref
                type_id: list
             nthreads: #TODO -- We need to loop over a list of threads
              type:
                type_id: integer
        ProfileTransaction:
          properties:
            flowops:
              type:
                items:
                  #TODO
                  type_id: one_of_string
              type_id: list
            #Note: duration is "runtime" in the benchmark-operator CR
            duration:
              type:
                type_id: string
  
              default: 60s
        ConnectFlowOp:
          properties:
            protocol: #TODO -- We need to loop over a list of protocols
              type:
                type_id: enum
            #TODO -- port and remotehost need to be set as part of the workflow steps when assigning a client to a server
            port:
              type:
                type_id: integer
            remotehost:
              type:
                type_id: string
  
        test_types:  list[enum] #FIXME -- these are pseudonyms for flowop combinations
        sizes:  list[integer] #FIXME -- this is a per-flowop param and they are single items per flowop


output: ${steps.run_uperf_client.output["success"]}


steps:
  #new function needed
  generate_uuid:
    #TODO
  #new plugin needed
  read_kubeconfig:
    plugin: quay.io/arcalot/read-kubeconfig-plugin:latest
    #TODO -- How do we collect the kubeconfig from the GlobalParams?
  #new plugin needed
  platform_config:
    plugin: quay.io/arcalot/kubernetes-platform-config-plugin:latest
    #TODO -- PlatformParams apply here
  #new plugin needed
  server_job_config:
    plugin: quay.io/arcalot/kubernetes-job-config-plugin:latest
    #TODO -- SUTParams apply here, and we may need to feed metadata for matching clients and servers
  #new plugin needed
  client_job_config:
    plugin: quay.io/arcalot/kubernetes-job-config-plugin:latest
    #TODO -- SUTParams apply here, and we may need to feed metadata for matching clients and servers
  #new plugin needed
  metadata_collector:
    plugin: quay.io/arcalot/kubernetes-metrics-collector-plugin:latest
    input:
      credentials: ${steps.read_kubeconfig.output["success"].credentials}
      namespace: default
  run_uperf_server:
    #feature needed for anti-affinity w/ client pods
    steps:
      uperf_server:
        plugin: quay.io/arcalot/uperf-plugin:latest
        job_config: ${steps.server_job_config.output["success"]}
        step: server
        deploy:
          node: ${steps.run_uperf_server.current_item}
  run_uperf_client:
    #feature needed for anti-affinity w/ server pods
    needs:
      - steps.run_uperf_server.output["success"]
    steps:
      uperf_client:
        plugin: quay.io/arcalot/uperf:latest
        job_config: ${steps.client_job_config.output["success"]}
        step: client
        deploy:
          node: ${steps.run_uperf_client.current_item}
        input:
          target: ${select_random{steps.host_lookup.output["success"].host}}
  #new plugin needed
  es_translator:
    needs:
      - steps.metadata_collector.output["success"]
      - steps.metrics_collector.output["success"]
      - steps.run_uperf_client.output["success"]
    plugin: quay.io/arcalot/es-translator-plugin:latest
  #new plugin needed
  es_benchmark_wrapper_adapter:
    needs:
      - steps.es_translator.output["success"]
    plugin: quay.io/arcalot/es-benchmark-wrapper-adapter-plugin:latest